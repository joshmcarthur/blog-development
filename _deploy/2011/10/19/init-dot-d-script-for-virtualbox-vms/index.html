
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Safely Start and Stop VirtualBox VMs with init.d - blog.joshmcarthur.com</title>
  <meta name="author" content="@sudojosh">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://blog.joshmcarthur.com/2011/10/19/init-dot-d-script-for-virtualbox-vms/"/>
  <link href="/favicon.ico" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="blog.joshmcarthur.com" type="application/atom+xml"/>
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>


<body  >
  <div id="container">
      <header><hgroup>
  <h1><a href="/">blog.joshmcarthur.com</a></h1>
  
</hgroup>



</header>

      <div id="main" role="main">
        <div id="content">
          <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">Safely Start and Stop VirtualBox VMs With init.d</h1>
    
    
      <p class="meta">





  



<time datetime="2011-10-19T17:05:00+13:00" pubdate  data-updated="true" >Oct 19<span>th</span>, 2011</time></p>
    
  </header>


<div class="entry-content"><p>Recently I&#8217;ve rolled out a virtual machine host box to run headless VMs (headless means that there is no display, keyboard etc plugged into it), as these make great test and experiment machines for trying new things out. As part of this rollout, I mashed a couple of blogs and some documentation together and came up with this script:</p>

<div><figure role=code><figcaption><span>/etc/init.d/virtual_machines  </span></figcaption>
 <div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
</pre></td><td class='code' width='100%'><pre><code class='bash'><div class='line'><span class="c">#!/bin/sh</span>
</div><div class='line'>
</div><div class='line'><span class="c"># virtual_machines  Start and stop virtual machines when the host changes state</span>
</div><div class='line'><span class="c">#</span>
</div><div class='line'><span class="c">#</span>
</div><div class='line'><span class="nv">VMUSER</span><span class="o">=</span>administrator
</div><div class='line'>
</div><div class='line'><span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
</div><div class='line'>    start<span class="o">)</span>
</div><div class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Starting VirtualBox VMs&quot;</span>
</div><div class='line'>        <span class="k">if</span> <span class="o">[</span> -f /etc/virtualbox/machines_enabled <span class="o">]</span>; <span class="k">then</span>
</div><div class='line'><span class="k">            </span>cat /etc/virtualbox/machines_enabled | <span class="k">while </span><span class="nb">read </span>VM; <span class="k">do</span>
</div><div class='line'><span class="k">              </span>sudo -H -b -u <span class="nv">$VMUSER</span> /usr/bin/VBoxHeadless -startvm <span class="s2">&quot;$VM&quot;</span>
</div><div class='line'>            <span class="k">done</span>
</div><div class='line'><span class="k">        fi</span>
</div><div class='line'>        ;;
</div><div class='line'>    stop<span class="o">)</span>
</div><div class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Saving state of VirtualBox VM...&quot;</span>
</div><div class='line'>        cat /etc/virtualbox/machines_enabled | <span class="k">while </span><span class="nb">read </span>VM; <span class="k">do</span>
</div><div class='line'><span class="k">          </span>sudo -H -u <span class="nv">$VMUSER</span> /usr/bin/VBoxManage controlvm <span class="s2">&quot;$VM&quot;</span> savestate
</div><div class='line'>        <span class="k">done</span>
</div><div class='line'>        ;;
</div><div class='line'>    *<span class="o">)</span>
</div><div class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Usage: /etc/init.d/virtual_machines {start|stop}&quot;</span>
</div><div class='line'>        <span class="nb">exit </span>1
</div><div class='line'>        ;;
</div><div class='line'><span class="k">esac</span>
</div><div class='line'>
</div><div class='line'><span class="nb">exit </span>0
</div></code></pre></td></tr></table></div></figure></div>


<p>I wrote this because this isn&#8217;t something that is supported directly by VirtualBox, and it&#8217;s essential that on a headless server that these virtual machines be able to go up and down happily without harm and reliably. It supports start and stop explanations and uses savestate, rather than poweroff - essentially, as the host server goes down, it will &#8216;hibernate&#8217; each VM, and then restore when the server starts back up again.</p>

<p>Another feature that I built into this was the use of a file in which a list of VMs can be specified to start and stop - for example, if you only want this script to deal with a subset of the virtual machines you have set up on the host server.</p>

<p>An example of this file might look like this:</p>

<div><figure role=code><figcaption><span>/etc/virtualbox/virtual_machines </span></figcaption>
<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
</pre></td><td class='code' width='100%'><pre><code class=''><div class='line'>winxp_development
</div><div class='line'>win7_development
</div><div class='line'>ubuntu_11_10_development</div></code></pre></td></tr></table></div></figure></div>


<p>It works really well for me, and since it&#8217;s something I had trouble tracking down, hopefully I can make someone&#8217;s life a little easier with this solution.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">@sudojosh</span></span>

      





  



<time datetime="2011-10-19T17:05:00+13:00" pubdate  data-updated="true" >Oct 19<span>th</span>, 2011</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.joshmcarthur.com/2011/10/19/init-dot-d-script-for-virtualbox-vms/" data-via="sudojosh" data-counturl="http://blog.joshmcarthur.com/2011/10/19/init-dot-d-script-for-virtualbox-vms/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'blog-joshmcarthur';
  var disqus_identifier = 'http://blog.joshmcarthur.com/2011/10/19/init-dot-d-script-for-virtualbox-vms/';
  var disqus_url = 'http://blog.joshmcarthur.com/2011/10/19/init-dot-d-script-for-virtualbox-vms/';
  //var disqus_developer = 1;
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside role=sidebar>
  
    <section>
  <h1>Search</h1>
  <form action="http://google.com/search" method="get" class="search">
    <fieldset role="site-search">
      <input type="hidden" name="q" value="site:blog.joshmcarthur.com" />
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    </fieldset>
  </form>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/02/28/git-browse-for-quick-repo-viewing/">Git-browse for Quick Repo Viewing</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/14/upcoming-ratemycourses/">Upcoming: RateMyCourses</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/12/add-jquery-to-any-page/">Add jQuery to Any Page Really, Really Easily</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/03/generating-gem-install-commands-from-gem-list/">Generating &#8216;Gem Install&#8217; Commands From &#8216;Gem List&#8217;</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/20/a-fun-little-bookmarklet/">A Fun Little Bookmarklet</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/joshmcarthur">@joshmcarthur</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'joshmcarthur',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("sudojosh", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/sudojosh" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @sudojosh</a>
  
</section>




  
</aside>


        </div>
      </div>
      <footer><p>
  Copyright &copy; 2012 - <a href="http://twitter.com/sudojosh">@sudojosh</a>
</p>
<p class="credits">
  <span class="octopress"><a href="http://octopress.org/">Octopress</a> powers this blog!</span>
  <span class="subtlepatterns"><a href="http://twitter.com/dwaseem">Waseem Dahman</a> made this beautiful background!</span>
<p>

</footer>
  </div>
  

  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>

