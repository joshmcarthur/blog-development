
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>blog.joshmcarthur.com</title>
  <meta name="author" content="@sudojosh">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://blog.joshmcarthur.com/page/6/index.html"/>
  <link href="/favicon.ico" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="blog.joshmcarthur.com" type="application/atom+xml"/>
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>


<body  >
  <div id="container">
      <header><hgroup>
  <h1><a href="/">blog.joshmcarthur.com</a></h1>
  
</hgroup>



</header>

      <div id="main" role="main">
        <div id="content">
          <div class="blog-index">



  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/11/integration-tests-with-devise-and-rspec/">Integration Tests With Devise and RSpec</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-06-11T00:00:00+12:00" pubdate  data-updated="true" >Jun 11<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>RSpec 2 has supported integration tests for a while now, and I&#8217;ve chosen to use
these for a project I&#8217;m working on at the moment instead of Cucumber (I don&#8217;t
feel that I need the verbosity andÂ English-like structure Cucumber provides
given that it a more complex process to write tests).
A bit of a problem I&#8217;ve come across recently is how to get a Devise user signed
in to your application in your tests, given that integration tests don&#8217;t really
give you any access to either the session or the controller (This rules out
manually setting ID&#8217;s in the session, or stubbing out current_user. As it turns
out, the implementation of it is pretty simple, but I did have to do a bit of
browsing and piece a few bits together to work out a nice way of doing it.
Here is the code you can use (You would normally place this within a before(:
each) filter in your routes spec (Which is what an integration test in RSpec is
called):
[At top of spec file, after require &#8216;spec_helper&#8217;
include Warden::Test::Helpers
[In a before(:each) block]
@user = Factory.create(:user)
@user.confirm!
login_as @user, :scope => :user
Now, what is this doing? Well, first of all, you include some test helpers that
Warden (Which devise back-ends onto), provides. I tried out using Devise&#8217;s
Devise::TestHelpers here, but it looks like Devise haven&#8217;t really designed
their helpers with integration tests in mind - they didn&#8217;t really work.Â 
Within our before(:each) block, it now gets pretty simple. We create a User,
using Factory Girl (This part of the implementation doesn&#8217;t really matter, you
can use fixtures if you prefer, or even a plain old User.create.
Next, we confirm the user. This isn&#8217;t necessary if your users haven&#8217;t been
marked as :confirmable in your User model, but obviously our new user needs to
be confirmed and active in order to log in.
Last of all, we use a helper method Warden&#8217;s test helpers has provided us to
log in the user, which sets us up for any more requests we need to make.
Have fun speccing nicely with Devise/Warden and RSpec!</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/07/quick-get-random-record-efficiently-in-rails/">Quick: Get Random Record Efficiently in Rails</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-06-07T00:00:00+12:00" pubdate  data-updated="true" >Jun 7<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>You could use SQL&#8217;s random function (RAND() or RANDOM() depending on database
engine) - but this isn&#8217;t database agnostic, so isn&#8217;t really very quick.
Instead you can use @nzkoz&#8217;s suggested method:
Widget.first(:offset => Widget.count)
&#8230;. the count() method is fast, and the first() method will limit it to the
first result in the SQL as well.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/05/06/imagemagick-cropping-then-resizing-a-png/">ImageMagick: Cropping Then Resizing a PNG</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-05-06T00:00:00+12:00" pubdate  data-updated="true" >May 6<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve been working on an image processor class for work, and recently ran into
this issue. I thought I would post it up here as normally I need to be quite
desperate before I start trawling through email mirrors - hopefully somebody
comes across this post first.
If you use ImageMagick (in particular, in conjunction with MiniMagick), then
you may come across this issue, and there is actually a quick fix to it. The
issue itself is as follows: my image processor retrieves an image from an
online source, but the image has a 1 or 2px border, and is thousands of pixels
wide - too wide for web use. I therefore wrote this class to first crop the
border off the image, and then resize it.
If you do actually do this though, there is an important step that needs to go
in-between the cropping and the resizing. If you won&#8217;t do this, you will
basically get a PNG layer that is offset from the image itself - i.e. some or
all of the Â actual image content is not visible. This happens because when the
image is cropped, the origin of the image changes. It needs to be reset back to
coordinates 0, 0 in order to not offset the layer itself when the image is
resized.
Here&#8217;s how to do it.Â 
For Ruby/Minimagick:
image.set(&#8220;page&#8221;, &#8220;#{image[&#8216;width&#8217;]}x#{image[&#8216;height&#8217;]}+0+0&#8221;)
For ImageMagick directly (i.e. in console):
convert [image sequence]: -set page [width]x[height]+0+0
Simple! The image should save correctly.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/04/12/using-setinterval-to-handle-scroll-events/">Using setInterval to Handle Scroll() Events</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-04-12T00:00:00+12:00" pubdate  data-updated="true" >Apr 12<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve just added a nice unobtrusive scroll to top feature to my blog, and learnt
an interesting tip in the process I thought I would share, originating from one
of the many problems Twitter has had with it&#8217;s jQuery fanciness.
The scroll to top stuff isn&#8217;t overly complicated - just detect when the user
has scrolled x pixels down the screen, and then show a link to go back to the
top (Which can be animated if you want) - for a nice tutorial on this, check
out_this_tutorial.
The thing is that this technique uses the scroll event (bound to window, but
can be bound to basically anything with a scrollbar). The scroll event gets
fired any time the window is scrolled - but any time the scroll amount changes
at all. What this means is that the scroll event is fired any time scroll
position changes - so if you grab the scrollbar, and pull, the scroll event is
fired every time the bar moves, not when you release the mouse.
John_Resig_reports_that_Twitter_ran_into_some_problems_with_thisÂ - they had a
function bound directly to the scroll event being fired every time anyone
scrolled (at all!). Resig has also reported a nice solution though, which I&#8217;ll
pass on here. It&#8217;s actually quite simple. Instead of binding a complicated
function to the scroll event, you simply set a flag variable to let something
else know that the window has been scrolled. The second piece of the solution
is a function running via setInterval - that is, a function being called on a
scheduled basis. The first task of this function is to check this flag - if it
is set, it can perform any task (Such as showing a &#8216;Back to Top&#8217; link, and set
the flag variable back to false.Â 
The end result of this solution is that you basically have a polling function,
rather than an event-driven one. This is actually a good thing though, when it
comes to this type of event. Instead of having a complex function called every
time the window is scrolled, a function is called every quarter second or so,
and only executes if the window has been scrolledÂ - much better!
I personally used an object variable, rather than just a flag - this object was
populated with the object that was scrolled on, and I then checked if this
object was populated in my polling function (rather than just is true), and
could then use the context it provided in this function. Since then, however, I
have realized that in my case, this object will alwaysbe the window object - so
I may as well have a cheaper variable assignment and just directly refer to the
object in my polling function.</p>
</div>
  
  


  </article>

<nav role="pagination">
  <div>
    
      <a class="prev" href="/page/7/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/page/5/">Newer &rarr;</a>
    
  </div>
</nav>

<script type="text/javascript">
    var disqus_shortname = 'blog-joshmcarthur';
    (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>
<aside role=sidebar>
  
    <section>
  <h1>Search</h1>
  <form action="http://google.com/search" method="get" class="search">
    <fieldset role="site-search">
      <input type="hidden" name="q" value="site:blog.joshmcarthur.com" />
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    </fieldset>
  </form>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/02/28/git-browse-for-quick-repo-viewing/">Git-browse for Quick Repo Viewing</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/14/upcoming-ratemycourses/">Upcoming: RateMyCourses</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/12/add-jquery-to-any-page/">Add jQuery to Any Page Really, Really Easily</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/03/generating-gem-install-commands-from-gem-list/">Generating &#8216;Gem Install&#8217; Commands From &#8216;Gem List&#8217;</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/20/a-fun-little-bookmarklet/">A Fun Little Bookmarklet</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/joshmcarthur">@joshmcarthur</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'joshmcarthur',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("sudojosh", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/sudojosh" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @sudojosh</a>
  
</section>




  
</aside>

        </div>
      </div>
      <footer><p>
  Copyright &copy; 2012 - <a href="http://twitter.com/sudojosh">@sudojosh</a>
</p>
<p class="credits">
  <span class="octopress"><a href="http://octopress.org/">Octopress</a> powers this blog!</span>
  <span class="subtlepatterns"><a href="http://twitter.com/dwaseem">Waseem Dahman</a> made this beautiful background!</span>
<p>

</footer>
  </div>
  

  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>

